

 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="PnlGOVh4Il" />
    
    
    
    
    <title>SQLServer2008中新增的变更数据捕获(CDC)和更改跟踪 | Mars(hnynes)</title>


    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Mars (hnynes)">
    

    
    <!--<%- open_graph({twitter_id: theme.author.twitter, google_plus: theme.author.google_plus}) %>-->

    <meta name="description" content="page.description">
    
    <meta property="og:type" content="article">
    
    <meta property="og:title" content="SQLServer2008中新增的变更数据捕获(CDC)和更改跟踪">
    <meta property="og:url" content="https://hnynes.github.io/mssql/2012/10/10/SQLServer2008%E4%B8%AD%E6%96%B0%E5%A2%9E%E7%9A%84%E5%8F%98%E6%9B%B4%E6%95%B0%E6%8D%AE%E6%8D%95%E8%8E%B7(CDC)%E5%92%8C%E6%9B%B4%E6%94%B9%E8%B7%9F%E8%B8%AA/">
    <meta property="og:site_name" content="Mars(hnynes)">
    <meta property="og:description" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="SQLServer2008中新增的变更数据捕获(CDC)和更改跟踪">
    <meta name="twitter:description" content="page.description">
    <meta name="twitter:creator" content="@">
    <link rel="publisher" href="">

    
    <link rel="alternative" href="https://hnynes.github.io/atom.xml" title="Mars(hnynes)" type="application/atom+xml">
    
    
    

    <link rel="stylesheet" href="https://hnynes.github.io/assets/css/style.css" type="text/css">
    <link rel="stylesheet" href="https://hnynes.github.io/assets/css/highlight.css" type="text/css">
    
    <style>
        body >header {
            background: url("https://hnynes.github.io/assets/img/banner.jpg") center #2ca6cb;
        }
    </style>
    
    
</head>

  <body>
    <header>
        <div>
		    
			<div id="textlogo">
				<h1 class="site-name"><a href="https://hnynes.github.io/" title="Mars(hnynes)">Mars(hnynes)</a></h1>
				<h2 class="blog-motto">Keep hungury, keep fooling.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="https://hnynes.github.io/">Home</a></li>
					
						<li><a href="https://hnynes.github.io/archives">Archives</a></li>
					
						<li><a href="https://hnynes.github.io/about">About</a></li>
					
					<li>
 					
					<form class="search" action="https://hnynes.github.io/search" method="get" accept-charset="utf-8">
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>
</div>

    </header>
    <div id="container">
      



<div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
	<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="https://hnynes.github.io/mssql/2012/10/10/SQLServer2008%E4%B8%AD%E6%96%B0%E5%A2%9E%E7%9A%84%E5%8F%98%E6%9B%B4%E6%95%B0%E6%8D%AE%E6%8D%95%E8%8E%B7(CDC)%E5%92%8C%E6%9B%B4%E6%94%B9%E8%B7%9F%E8%B8%AA/" title="SQLServer2008中新增的变更数据捕获(CDC)和更改跟踪" itemprop="url">SQLServer2008中新增的变更数据捕获(CDC)和更改跟踪</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://hnynes.github.io/about" title="Mars (hnynes)" target="_blank" itemprop="author">Mars (hnynes)</a>
		
  <p class="article-time">
    <time datetime="2012-10-10 00:00:00 +0800" itemprop="datePublished"> 发表于 2012-10-10</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article toc-content" style="display: none;">
		
			<!--<%- toc(item.content) %>-->
		
		</div>
		
		<p>[转载文章]</p>

<p>SQL Server 2008中新增的变更数据捕获(CDC)和更改跟踪</p>

<p>SQL Server 2008中SQL应用系列–目录索引<br />
本文主要介绍SQL Server中记录数据变更的四个方法：</p>
<blockquote>
  <p>触发器<br />
Output子句<br />
变更数据捕获（Change Data Capture 即CDC）功能<br />
同步更改跟踪<br />
其中后两个为SQL Server 2008所新增。</p>
</blockquote>

<p>一、触发器</p>

<p>在SQL Server的早期版本中，如果要记录某个表或视图的Insert/Update/Delete操作，我们可以借助触发器（Trigger）（http://msdn.microsoft.com/zh-cn/library/ms189799.aspx）,这在数据量较小的情况下往往是有效的方式之一，其中后触发器（After Trigger）只能跟踪表的三个操作中的任意组合，而前触发器（Instead Of trigger）可以处理表和视图的更新（即使普通的Update View语句在某些列不明确的情况下报错）。我们看两个例子：</p>

<p>准备基础数据：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USE testDb2
GO
--创建两个测试表
IF NOT OBJECT_ID('DepartDemo') IS NULL
DROP TABLE [DepartDemo]
GO
IF NOT OBJECT_ID('DepartChangeLogs') IS NULL
DROP TABLE [DepartChangeLogs]
GO
--测试表
CREATE TABLE [dbo].[DepartDemo](
[DID] [int] IDENTITY(101,1) NOT NULL PRIMARY KEY,
[DName] [nvarchar](200) NULL,
[DCode] [nvarchar](500) NULL,
[Manager] [nvarchar](50) NULL,
[ParentID] [int] NOT NULL DEFAULT ((0)),
[AddUser] [nvarchar](50) NULL,
[AddTime] [datetime] NULL,
[ModUser] [nvarchar](50) NULL,
[ModTime] [datetime] NULL,
[CurState] [smallint] NOT NULL DEFAULT ((0)),
[Remark] [nvarchar](500) NULL,
[F1] [int] NOT NULL DEFAULT ((0)),
[F2] [nvarchar](300) NULL
)
GO
--记录日志表
CREATE TABLE [DepartChangeLogs]
([LogID] [bigint] IDENTITY(1001,1) NOT NULL PRIMARY KEY,
[DID] [int] NOT NULL,
[DName] [nvarchar](200) NULL,
[DCode] [nvarchar](500) NULL,
[Manager] [nvarchar](50) NULL,
[ParentID] [int] NOT NULL DEFAULT ((0)),
[AddUser] [nvarchar](50) NULL,
[AddTime] [datetime] NULL,
[ModUser] [nvarchar](50) NULL,
[ModTime] [datetime] NULL,
[CurState] [smallint] NOT NULL DEFAULT ((0)),
[Remark] [nvarchar](500) NULL,
[F1] [int] NOT NULL DEFAULT ((0)),
[F2] [nvarchar](300) NULL,
[LogTime] DateTime Default(Getdate()) Not Null,
[InsOrUpd] char not null
)
GO 创建触发器：

/*******　　　创建一个After DML触发器　　******/
/********* 3w@live.cn 邀月***************/
CREATE TRIGGER dbo.tri_LogDepartDemo
ON [dbo].[DepartDemo]
AFTER INSERT, Delete /************此处使用update与“Insert,Delete”效果是一样的，邀月注 **********/
AS
SET NOCOUNT ON --屏蔽触发器发送“受影响的行数”给应用程序

-- Inserted rows
INSERT [DepartChangeLogs]
(DID,[DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2],
 LogTime, InsOrUPD)
SELECT DISTINCT DID,[DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2],
 GETDATE(), 'I'
FROM inserted i

-- Deleted rows
INSERT [DepartChangeLogs]
(DID,[DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2],
 LogTime, InsOrUPD)
SELECT DISTINCT DID,[DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2],
 GETDATE(), 'D'
FROM deleted d
GO

INSERT [dbo].[DepartDemo] ([DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2])
VALUES (N'国家统计局房产审计一科', N'0', N'胡不归', 0, N'DeomUser',
 CAST(0x00009DF7017B6F96 AS DateTime), N'', CAST(0x0000000000000000 AS DateTime),
 1, N'专业评估全国房价，为老百姓谋福祉', 0, N'')
GO

----该Update不会被触发器记录，但Update会生效
UPDATE departDemo SET [Manager]='任我行' WHERE DID=101
GO

DELETE FROM departDemo where DID=101
GO

SELECT * FROM [DepartChangeLogs]  
</code></pre></div></div>

<p>统计效果：<br />
<!-- ![](/assets/img/2012-10-10-p1.png) -->
<img src="/assets/img/2012-10-10-p1.png" alt="" /></p>

<p>如果你觉得触发器过于浪费，你可以试着根据某些字段以缩小触发器的范围</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/********* 使用DML触发器记录特定列的修改 ***/
/********* 3w@live.cn 邀月***************/
CREATE TRIGGER dbo.[tri_LogDepartDemo2]
ON [dbo].[DepartDemo]
AFTER Update
AS
IF Update([Manager])
    Begin
        print '该部门主管实行终身任免制，不得中途更改！'
        Rollback ----回滚Update操作
    End

GO
UPDATE departDemo SET [Manager]='任我行' WHERE DID=101
GO  
</code></pre></div></div>

<p>执行结果：<br />
<img src="/assets/img/2012-10-10-p2.png" alt="" /></p>

<p>但触发器的缺陷也是显而易见的，使用触发器请注意以下几点：</p>

<blockquote>
  <p>1、触发器通常很隐蔽，换句话说，易忘记，特别在检查性能和逻辑问题时。</p>
</blockquote>

<blockquote>
  <p>2、长时间运行的触发器会严重减慢数据操作，特别是在数据频繁修改的数据库中。</p>
</blockquote>

<blockquote>
  <p>3、不记录日志的更新不会引起DML触发器的触发（如WRITETEXT、Trunacte table及批量插入操作）。</p>
</blockquote>

<blockquote>
  <p>4、约束通常比触发器运行更快。</p>
</blockquote>

<blockquote>
  <p>5、处理某些逻辑时，存储过程通常比触发器要更易维护和管理。</p>
</blockquote>

<blockquote>
  <p>6、不允许在触发器中使用Select返回结果集。</p>
</blockquote>

<p>关于触发器的更多内容，请看MSDN（http://msdn.microsoft.com/zh-cn/library/ms189799.aspx）</p>

<p>二、使用Output子句</p>

<p>官方解释：OutPut子句（http://technet.microsoft.com/zh-cn/library/ms177564.aspx）返回受 INSERT、UPDATE、DELETE 或 MERGE 语句影响的各行中的信息，或返回基于受这些语句影响的各行的表达式。 这些结果可以返回到处理应用程序，以供在确认消息、存档以及其他类似的应用程序要求中使用。 也可以将这些结果插入表或表变量。 另外，您可以捕获嵌入的 INSERT、UPDATE、DELETE 或 MERGE 语句中 OUTPUT 子句的结果，然后将这些结果插入目标表或视图。</p>

<p>举例：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/********* 使用Output记录表记录的修改 *****/

----删除前面的触发器
Drop TRIGGER dbo.[tri_LogDepartDemo]
DROP TRIGGER dbo.[tri_LogDepartDemo2]

INSERT [dbo].[DepartDemo] ([DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2])
OUTPUT Inserted.*,getdate(),'I' ---注意这行是新增的
INTO DepartChangeLogs ---注意这行是新增的
VALUES (N'发改委', N'0', N'向问天', 0, N'DeomUser',
 CAST(0x00009DF7017B6F96 AS DateTime), N'', CAST(0x0000000000000000 AS DateTime),
 1, N'油价，我说了算', 0, N'')
GO

SELECT * FROM [DepartChangeLogs]
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p3.png" alt="" /></p>

<p>注意：</p>

<blockquote>
  <p>1、从OUTPUT 中返回的列反映 INSERT、UPDATE 或 DELETE 语句完成之后但在触发器执行之前的数据。</p>
</blockquote>

<blockquote>
  <p>2、SQL Server 并不保证由使用 OUTPUT 子句的 DML 语句处理和返回行的顺序。</p>
</blockquote>

<blockquote>
  <p>3、与触发器相比，OutPut子句可以直接处理Merge语句。</p>
</blockquote>

<p>以上两种方法各有千秋，在合适的情况下采取合适的方法才是明智的选择，令人惊喜的是，SQL Server 2008起，为我们提供了更为强大的内建的方法－变更数据捕获（CDC，http://msdn.microsoft.com/zh-cn/library/bb500244%28v=sql.100%29.aspx）和更改跟踪，下面我们隆重介绍它们。</p>

<p>三、使用“变更数据捕获”（CDC）功能</p>

<p>SQL Server 2008提供了内建的方法变更数据捕获（Change Data Capture 即CDC）以实现异步跟踪用户表的数据修改，而且这一功能拥有最小的性能开销。可以用于其他数据源的持续更新，例如将OLTP数据库中的数据变更迁移到数据仓库数据库。</p>

<p>要使用CDC功能，首先我们得在数据库中启用该功能。在此我们沿用上例中使用的数据库Testdb2</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**************异步跟踪数据更新演示*************/ 

use master 
GO 
IF EXISTS (SELECT [name] FROM sys.databases WHERE name = 'TestDb2') 
    drop DATABASE TestDb2 
Go 
CREATE DATABASE TestDb2 
GO 
--查看是否启用CDC 
SELECT is_cdc_enabled FROM sys.databases WHERE name = 'TestDb2' 
USE TestDb2 
GO ----启用当前数据库的CDC功能 EXEC sys.sp_cdc_enable_db GO
　　如果报15517错误，请换用其他owner，邀月注

SELECT is_cdc_enabled FROM sys.databases WHERE name = 'TestDb2' 
/* is_cdc_enabled 1 */ 
USE testDb2 
GO 
CREATE TABLE [dbo].[DepartDemo]( 
[DID] [int] IDENTITY(101,1) NOT NULL PRIMARY KEY, 
[DName] [nvarchar](200) NULL, 
[DCode] [nvarchar](500) NULL, 
[Manager] [nvarchar](50) NULL, 
[ParentID] [int] NOT NULL DEFAULT ((0)), 
[AddUser] [nvarchar](50) NULL, 
[AddTime] [datetime] NULL, 
[ModUser] [nvarchar](50) NULL, 
[ModTime] [datetime] NULL, 
[CurState] [smallint] NOT NULL DEFAULT ((0)),
[Remark] [nvarchar](500) NULL,
[F1] [int] NOT NULL DEFAULT ((0)),
[F2] [nvarchar](300) NULL
)
GO
/**********************************
需要启用SQL Server Agent服务，否则会报错, SQLServerAgent is not currently running so it cannot be notified of this action.
***********************************/
/****** 捕获所有的行变更，只返回行的净变更，其他默认 *******/
EXEC sys.sp_cdc_enable_table
@source_schema = 'dbo',
@source_name = 'DepartDemo',
@role_name = NULL,
@capture_instance = NULL,
@supports_net_changes = 1,
@index_name = NULL,
@captured_column_list = NULL,
@filegroup_name = default
　　注意此时，SQL Server 自启动了两个job,一个捕获，一个清除，注意清除是默认凌晨２点，清除72小时以上的数据。如果同一数据库的表中CDC已经启用，不会重建job。

/* 
Job 'cdc.TestDb2_capture' started successfully. 
Job 'cdc.TestDb2_cleanup' started successfully. 
*/ 
--确认表已经被跟踪 
SELECT is_tracked_by_cdc FROM sys.tables 
WHERE name = 'DepartDemo' and schema_id = SCHEMA_ID('dbo')
/* is_tracked_by_cdc 1 */
--确认
EXEC sys.sp_cdc_help_change_data_capture 'dbo', 'DepartDemo'
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p4.png" alt="" /></p>

<p>可以看到，SQL Server 增加了一个表[cdc].[dbo_DepartDemo_CT] 
相比源表多了个字段:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[__$start_lsn]  
,[__$end_lsn]   
,[__$seqval]  
,[__$operation]  
,[__$update_mask] 
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p5.png" alt="" /></p>

<p>不建议直接查询该表，而应该使用下面的技巧：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USE TestDb2
GO

INSERT [dbo].[DepartDemo] ([DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2])
VALUES (N'银监会', N'0', N'云中鹤', 0, N'DemoUser1',
CAST(0x00009DF7017B6F96 AS DateTime), N'', CAST(0x0000000000000000 AS DateTime),
1, N'监管汇率', 0, N'')

INSERT [dbo].[DepartDemo] ([DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2])
VALUES (N'统计局', N'0', N'神算子', 0, N'DemoUser2',
CAST(0x00009DF7017B6F96 AS DateTime), N'', CAST(0x0000000000000000 AS DateTime),
1, N'统计数据', 0, N'')
GO

UPDATE [dbo].[DepartDemo]
SET Manager='段正淳'
WHERE DID =101

DELETE [dbo].[DepartDemo]
WHERE DID = 102 要查询变更，我们需要借助大名鼎鼎的日志序列号（Log Sequence Numbers）即LSN（http://msdn.microsoft.com/zh-cn/library/ms190411%28v=sql.100%29.aspx）来实现LSN级别的跟踪数据变更。 下面示例中sys.fn_cdc_map_time_to_lsn（http://msdn.microsoft.com/zh-cn/library/bb500137%28v=sql.100%29.aspx）用于LSN转换为时间。

/******* 使用LSN 查看CDC记录 *********/

--http://msdn.microsoft.com/zh-cn/library/bb500137%28v=sql.100%29.aspx
SELECT sys.fn_cdc_map_time_to_lsn
( 'smallest greater than or equal' , '2012-04-09 16:09:30') as BeginLSN

/*
BeginLSN
0x0000002C000000AA0003
*/

SELECT sys.fn_cdc_map_time_to_lsn
( 'largest less than or equal' , '2012-04-09 23:59:59') as EndLSN

/*
EndLSN
0x0000002C000001C20005
*/

/**************查看所有CDC记录*************/

DECLARE @FromLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'smallest greater than or equal' , '2012-04-09 16:09:30')

DECLARE @ToLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'largest less than or equal' , '2012-04-09 23:59:59')

SELECT
__$operation,
__$update_mask,
DID,
DName,
Manager
FROM [cdc].[fn_cdc_get_all_changes_dbo_DepartDemo]
(@FromLSN, @ToLSN, 'all')

/************查看所有更新*************************

__$operation __$update_mask DID DName Manager
2 0x1FFF 105 银监会 云中鹤
2 0x1FFF 106 统计局 神算子
1 0x1FFF 101 银监会 段正淳
1 0x1FFF 103 银监会 云中鹤
1 0x1FFF 104 统计局 神算子
1 0x1FFF 105 银监会 云中鹤
1 0x1FFF 106 统计局 神算子
2 0x1FFF 107 银监会 云中鹤
2 0x1FFF 108 统计局 神算子
4 0x0008 107 银监会 段正淳
1 0x1FFF 108 统计局 神算子
*/

/**************查看所有CDC记录*************/
DECLARE @FromLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'smallest greater than or equal' , '2012-04-09 16:09:30')

DECLARE @ToLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'largest less than or equal' , '2012-04-09 23:59:59')

--解释一下Operation的具体含义
SELECT
CASE __$operation
WHEN 1 THEN 'DELETE'
WHEN 2 THEN 'INSERT'
WHEN 3 THEN 'Before UPDATE'
WHEN 4 THEN 'After UPDATE'
END Operation,
__$update_mask,
DID,
DName,
Manager
FROM [cdc].[fn_cdc_get_all_changes_dbo_DepartDemo]
(@FromLSN, @ToLSN, 'all update old')
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p6.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**************查看净更改（Net changes）CDC记录*************/

INSERT [dbo].[DepartDemo] ([DName], [DCode], [Manager], [ParentID],
[AddUser], [AddTime], [ModUser], [ModTime], [CurState], [Remark], [F1], [F2])
VALUES (N'药监局', N'0', N'蝶谷医仙', 0, N'DemoUser3',
CAST(0x00009DF7017B6F96 AS DateTime), N'', CAST(0x0000000000000000 AS DateTime),
1, N'制定药价', 0, N'')
GO

UPDATE [dbo].[DepartDemo]
SET Manager='胡青牛'
WHERE DID =109

DECLARE @FromLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'smallest greater than or equal' , '2012-04-09 16:09:30')

DECLARE @ToLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'largest less than or equal' , '2012-04-09 23:59:59')

SELECT
CASE __$operation
WHEN 1 THEN 'DELETE'
WHEN 2 THEN 'INSERT'
WHEN 3 THEN 'Before UPDATE'
WHEN 4 THEN 'After UPDATE'
WHEN 5 THEN 'MERGE'
END Operation,
__$update_mask,
DID,
DName,
Manager
FROM [cdc].[fn_cdc_get_net_changes_dbo_DepartDemo]
(@FromLSN, @ToLSN, 'all with mask')
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p7.png" alt="" /></p>

<p>我们还可以通过转换CDC更新掩码获得更为直观的结果，这里需要借助于另外两个函数sys.fn_cdc_is_bit_set（http://msdn.microsoft.com/zh-cn/library/bb500241%28v=SQL.110%29.aspx）和sys.fn_cdc_get_column_ordinal（http://msdn.microsoft.com/zh-cn/library/bb522549%28v=SQL.100%29.aspx）</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/************** 转换CDC更新掩码 *************/

UPDATE dbo.[DepartDemo]
SET [Manager] = '东方不败'
WHERE DID =107

UPDATE dbo.[DepartDemo]
SET ParentID = 109
WHERE DID =107

DECLARE @FromLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'smallest greater than or equal' , '2012-04-09 16:09:30')

DECLARE @ToLSN varbinary(10) =
sys.fn_cdc_map_time_to_lsn
( 'largest less than or equal' , '2012-04-09 23:59:59')

SELECT
sys.fn_cdc_is_bit_set (
sys.fn_cdc_get_column_ordinal (
'dbo_DepartDemo' , 'Manager' ),
__$update_mask) Manager_Updated,
sys.fn_cdc_is_bit_set (
sys.fn_cdc_get_column_ordinal (
'dbo_DepartDemo' , 'ParentID' ),
__$update_mask) ParentID_Updated,
DID,
Manager,
ParentID
FROM cdc.fn_cdc_get_all_changes_dbo_DepartDemo
(@FromLSN, @ToLSN, 'all')
WHERE __$operation = 4
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p8.png" alt="" /></p>

<p>除了前面介绍的指定LSN边界的方法，SQL Server还提供了一系列的获取边界的方法：</p>

<p>sys.fn_cdc_get_max_lsn（http://msdn.microsoft.com/zh-cn/library/bb500304%28v=sql.100%29.aspx）</p>

<p>sys.fn_cdc_get_min_lsn（http://msdn.microsoft.com/zh-cn/library/bb510621%28v=sql.100%29.aspx）</p>

<p>sys.fn_cdc_increment_lsn（http://msdn.microsoft.com/zh-cn/library/bb510745%28v=sql.100%29.aspx）</p>

<p>sys.fn_cdc_decrement_lsn（http://msdn.microsoft.com/zh-cn/library/bb500246%28v=sql.100%29.aspx）</p>

<p>示例如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/************** 获取LSN边界的其他方法 *************/ 

--获取最小边界
SELECT sys.fn_cdc_get_min_lsn ('dbo_DepartDemo') Min_LSN
--获取可用的最大边界
SELECT sys.fn_cdc_get_max_lsn () Max_LSN
--获取最大边界的下一个序号
SELECT sys.fn_cdc_increment_lsn (sys.fn_cdc_get_max_lsn())
New_Lower_Bound_LSN
--获取最大边界的前一个序号
SELECT sys.fn_cdc_decrement_lsn (sys.fn_cdc_get_max_lsn())
New_Lower_Bound_Minus_one_LSN
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p9.png" alt="" /></p>

<p>通过以下存储过程在数据库和表级禁用CDC</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sys.sp_cdc_disable_table （http://msdn.microsoft.com/zh-cn/library/bb510702(v=sql.100).aspx）

sys.sp_cdc_disable_db（http://msdn.microsoft.com/zh-cn/library/bb522508(v=sql.100).aspx）注意，该命令同时也删除了CDC架构和相关的SQL代理作业。

/************** 在数据库和表级禁用CDC *************/
EXEC sys.sp_cdc_disable_table 'dbo', 'DepartDemo', 'all'
SELECT is_tracked_by_cdc FROM sys.tables
WHERE name = 'DepartDemo' and schema_id = SCHEMA_ID('dbo')
--当前数据库上禁用CDC
EXEC sys.sp_cdc_disable_db
</code></pre></div></div>

<p>四、使用“更改跟踪”以最小的磁盘开销跟踪净数据更改</p>

<p>CDC可以用来对数据库和数据仓库的持续数据变更进行异步数据跟踪，而SQL Server 2008中新增的“更改跟踪”却是一个同步进程，是DML操作本身（I/D/U）事务的一部分，它的最大优势是以最小的磁盘开销来侦测净行变更，它允许修改的数据以事务一致的形式表现，并提供了检测数据冲突的能力。它甚至可以根据外部传入的应用程序上下文，来完成更细颗粒度的更改处理，参看WITH CHANGE_TRACKING_CONTEXT （http://msdn.microsoft.com/zh-cn/library/bb895330%28v=sql.100%29.aspx）</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/***使用“更改跟踪”以最小的磁盘开销跟踪净数据更改****/
IF EXISTS (SELECT [name] FROM sys.databases WHERE name = 'TestDb4')
  drop DATABASE TestDb4
Go CREATE DATABASE TestDb4
GO --启用更新跟踪，36小时清理一次 ALTER DATABASE TestDb4 SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 36 HOURS, AUTO_CLEANUP = ON) 注意，下一步是允许快照隔离，这是微软推祟的“最佳实践”，尽管这样行版本的生成会增加额外的空间使用，从而会增加总的I/O数量,但不使用快照会引发事务不一致的变更信息。

ALTER DATABASE TestDb4
SET ALLOW_SNAPSHOT_ISOLATION ON
GO

SELECT DB_NAME(database_id) 数据库名称,is_auto_cleanup_on,
retention_period,retention_period_units_desc
FROM sys.change_tracking_databases
/*
数据库名称 is_auto_cleanup_on retention_period retention_period_units_desc
TestDb4 1 36 HOURS
*/

USE TestDb4
GO
--创建测试表
CREATE TABLE dbo.DepartDemo
([DID] [int] IDENTITY(101,1) NOT NULL PRIMARY KEY,
[DName] [nvarchar](200) NULL,
[Manager] [nvarchar](50) NULL,
[ParentID] [int] NOT NULL DEFAULT ((0)),
[CurState] [smallint] NOT NULL DEFAULT ((0)),
)
GO

----TRUNCATE table dbo.DepartDemo
----GO

--启用表的列更新跟踪
ALTER TABLE dbo.DepartDemo
ENABLE CHANGE_TRACKING
WITH (TRACK_COLUMNS_UPDATED = ON)

--确认是否更新跟踪开启
SELECT OBJECT_NAME(object_id) ObjNM,is_track_columns_updated_on
FROM sys.change_tracking_tables

/*
ObjNM is_track_columns_updated_on
DepartDemo 1
*/

--增加测试数据
INSERT dbo.DepartDemo
(DName,ParentID)
VALUES
('明教', 0),
('五行集', 101),
('少林派',0)

SELECT * FROM dbo.DepartDemo

--当前版本
SELECT CHANGE_TRACKING_CURRENT_VERSION ()
as 当前版本
/*
当前版本
1
*/
SELECT CHANGE_TRACKING_MIN_VALID_VERSION
( OBJECT_ID('dbo.DepartDemo') )as 最小可用版本

/*
最小可用版本
0
*/ 函数ChangeTable有两种用法来检测更改: 一、使用Changes关键字 二、使用Version关键字

/* 一、使用Changes关键字 */
SELECT DID,SYS_CHANGE_OPERATION, SYS_CHANGE_VERSION
FROM CHANGETABLE (CHANGES dbo.DepartDemo, 0) AS CT
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p10.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UPDATE dbo.DepartDemo SET Manager='张无忌' WHERE DID = 101
UPDATE dbo.DepartDemo SET [DName] = '五行旗' WHERE DID = 102
DELETE dbo.DepartDemo WHERE DID = 103
SELECT CHANGE_TRACKING_CURRENT_VERSION () as 当前版本 /* 当前版本 4 */
--版本1之后的更改
SELECT DID, SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION, SYS_CHANGE_COLUMNS FROM CHANGETABLE (CHANGES dbo.DepartDemo, 1) AS CT
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p11.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--返回哪些列被修改，1为真,0为假
SELECT DID,
CHANGE_TRACKING_IS_COLUMN_IN_MASK(
COLUMNPROPERTY(
OBJECT_ID('dbo.DepartDemo'),'DName', 'ColumnId') ,
SYS_CHANGE_COLUMNS) 是否改变DName,
CHANGE_TRACKING_IS_COLUMN_IN_MASK(
COLUMNPROPERTY(
OBJECT_ID('dbo.DepartDemo'), 'Manager', 'ColumnId') ,
SYS_CHANGE_COLUMNS) 是否改变Manager
FROM CHANGETABLE (CHANGES dbo.DepartDemo, 1) AS CT
WHERE SYS_CHANGE_OPERATION = 'U'
/* DID 是否改变DName 是否改变Manager 101 0 1 102 1 0 */
 

/* 二、使用Version关键字 */
SELECT d.DID, d.DName, d.Manager, ct.SYS_CHANGE_VERSION
FROM dbo.DepartDemo d
CROSS APPLY CHANGETABLE (VERSION dbo.DepartDemo , (DID), (d.DID)) as ct
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p12.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UPDATE dbo.DepartDemo SET DName = '中原明教', CurState = 0
WHERE DID = 101
SELECT d.DID, d.DName, d.Manager, ct.SYS_CHANGE_VERSION
FROM dbo.DepartDemo d
CROSS APPLY CHANGETABLE (VERSION dbo.DepartDemo , (DID), (d.DID)) as ct
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p13.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT CHANGE_TRACKING_CURRENT_VERSION () as 当前版本 /* 当前版本 5 */
--跟踪外部程序哪一部分引起的更改，这样好找出源头
DECLARE @context varbinary(128) = CAST('明教内讧引起分裂' as varbinary(128));
WITH CHANGE_TRACKING_CONTEXT (@context)
INSERT dbo.DepartDemo (DName, Manager) VALUES ('天鹰教', '殷天正')
--查询Context更改
SELECT DID, SYS_CHANGE_OPERATION, SYS_CHANGE_VERSION, CAST(SYS_CHANGE_CONTEXT as varchar) ApplicationContext
FROM CHANGETABLE (CHANGES dbo.DepartDemo, 5) AS CT
/* DID SYS_CHANGE_OPERATION SYS_CHANGE_VERSION ApplicationContext 104 I 6 明教内讧引起分裂 */
</code></pre></div></div>

<p><img src="/assets/img/2012-10-10-p14.png" alt="" /></p>

<p>小结：</p>

<p>本文总结了SQL Server中记录数据变更的四个方法：触发器、Output子句、SQL Server 2008中新增的变更数据捕获（CDC）功能、同步更改跟踪。其中后两个是SQL Server 2008中新增的功能，在SQL Server 2012中更是与Always ON紧密集成。</p>

<blockquote>
  <p>1、不建议前两个。</p>
</blockquote>

<blockquote>
  <p>2、CDC用以实现异步跟踪用户表的数据修改，而且这一功能拥有最小的性能开销，可以用于其他数据源的持续更新，例如将OLTP数据库中的数据变更迁移到数据仓库数据库。</p>
</blockquote>

<blockquote>
  <p>3、”更改跟踪”的最大优势是以最小的磁盘开销来侦测净行变更，它允许修改的数据以事务一致的形式表现，并提供了检测数据冲突的能力。</p>
</blockquote>

<p>其他推荐文章：</p>

<blockquote>
  <p>1、在VS中如何将数据同步配置为使用 SQL Server 更改跟踪（http://msdn.microsoft.com/zh-cn/library/cc714038.aspx）</p>
</blockquote>

<blockquote>
  <p>2、SQL Server 2012中复制、更改跟踪、更改数据捕获和 AlwaysOn 可用性组 (SQL Server)（http://msdn.microsoft.com/zh-cn/library/hh403414%28v=sql.110%29.aspx）</p>
</blockquote>

<p>原谅地址: http://www.cnblogs.com/downmoon/archive/2012/04/09/2439462.html</p>
  
	</div>
	<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <!--
  <%- list_categories(item.categories, {
      show_count: false,
      class: 'article-category',
      style: 'none',
      separator: '►'
  }) %>
  -->
  
  <a class="article-category-link" href="https://hnynes.github.io/categories/#mssql">mssql</a>
  
</div>


  <div class="article-tags">
  <!--
  <% var tags = [];
    item.tags.forEach(function(tag){
      tags.push('<a href="' + config.root + tag.path + '">' + tag.name + '</a>');
    }); %>-->
  <span></span> <!--<%- tags.join('') %>-->
  
  
  <a href="https://hnynes.github.io/tags/#mssql">mssql</a>
  
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://hnynes.github.io/mssql/2012/10/10/SQLServer2008%E4%B8%AD%E6%96%B0%E5%A2%9E%E7%9A%84%E5%8F%98%E6%9B%B4%E6%95%B0%E6%8D%AE%E6%8D%95%E8%8E%B7(CDC)%E5%92%8C%E6%9B%B4%E6%94%B9%E8%B7%9F%E8%B8%AA/" data-title="SQLServer2008中新增的变更数据捕获(CDC)和更改跟踪 | Mars(hnynes)" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>
   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="https://hnynes.github.io/mysql/2012/09/21/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-innodb%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0(%E4%B8%8B)/" title="mysql技术内幕-innodb存储引擎读书笔记(下)">
  <strong>上一篇：</strong><br/>
  <span>
  mysql技术内幕-innodb存储引擎读书笔记(下)</span>
</a>
</div>


<div class="next">
<a href="https://hnynes.github.io/linux/2012/10/25/History-%E5%8E%86%E5%8F%B2-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95/"  title="History（历史）命令用法">
 <strong>下一篇：</strong><br/> 
 <span>History（历史）命令用法
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>


</div>  

      
      
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside toc-content">
 
 <!--<%- toc(item.content) %>-->
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="https://hnynes.github.io/categories/#java" title="java">java<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#cplusplus" title="cplusplus">cplusplus<sup>11</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#windows" title="windows">windows<sup>7</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#learn" title="learn">learn<sup>8</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#mysql" title="mysql">mysql<sup>44</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#database" title="database">database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#network" title="network">network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#mssql" title="mssql">mssql<sup>50</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#项目管理" title="项目管理">项目管理<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#test" title="test">test<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#python" title="python">python<sup>2</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#ruby" title="ruby">ruby<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#linux" title="linux">linux<sup>9</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#program" title="program">program<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#oracle" title="oracle">oracle<sup>2</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#eng" title="eng">eng<sup>1</sup></a></li>
		  
		
		  
			<li><a href="https://hnynes.github.io/categories/#hadoop" title="hadoop">hadoop<sup>2</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="https://hnynes.github.io/tags/#java" title="java">java<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#cplusplus" title="cplusplus">cplusplus<sup>11</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#windows" title="windows">windows<sup>7</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#learn" title="learn">learn<sup>8</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#mysql" title="mysql">mysql<sup>44</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#database" title="database">database<sup>3</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#network" title="network">network<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#mssql" title="mssql">mssql<sup>50</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#项目管理" title="项目管理">项目管理<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#test" title="test">test<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#python" title="python">python<sup>2</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#ruby" title="ruby">ruby<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#linux" title="linux">linux<sup>9</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#program" title="program">program<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#oracle" title="oracle">oracle<sup>2</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#eng" title="eng">eng<sup>1</sup></a></li>
			
		
			
				<li><a href="https://hnynes.github.io/tags/#hadoop" title="hadoop">hadoop<sup>2</sup></a></li>
			
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div id="tagcloud" class="tagcloudlist clearfix">
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            <a href="https://my.oschina.net/hnyness" target="_blank" title="我的空间">我的空间</a>
          </li>
        
          <li>
            <a href="http://hnynes.blog.chinaunix.net" target="_blank" title="我的chinaunix博客">我的chinaunix博客</a>
          </li>
        
          <li>
            <a href="https://www.postgresql.org/" target="_blank" title="PostgreSQL官网">PostgreSQL官网</a>
          </li>
        
          <li>
            <a href="http://www.postgres.cn/v2/home" target="_blank" title="PostgreSQL中文社区">PostgreSQL中文社区</a>
          </li>
        
          <li>
            <a href="https://dev.mysql.com/doc/refman/5.7/en/" target="_blank" title="MySQL官文文档5.7">MySQL官文文档5.7</a>
          </li>
        
    </ul>
</div>

  


  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="hnynes" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="https://hnynes.github.io/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> Hello , I'm Mars(hnynes). <br/>
			This is my blog, believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/hnynes" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
	<!--
			<%  Array.prototype.S=String.fromCharCode(2);
			  Array.prototype.in_array=function(e){
    			var r=new RegExp(this.S+e+this.S);
    			return (r.test(this.S+this.join(this.S)+this.S));
				};
				var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>
		<% if (cc.in_array(theme.creative_commons) ) { %>
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0" class="cc-opacity" target="_blank">
            <img src="<%- config.root %>img/cc-<%= theme.creative_commons %>.svg" alt="Creative Commons" />
          </a>
        </div>
    <% } %>
				-->

		<p class="copyright">
		Powered by <a href="http://jekyllrb.com" target="_blank" title="jekyll">jekyll</a> and Theme by <a href="https://github.com/simpleyyt/jekyll-jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="about" target="_blank" title="Mars (hnynes)">Mars (hnynes)</a>
		
		
		</p>
</div>
</footer>
    <script src="https://hnynes.github.io/assets/js/jquery-2.0.3.min.js"></script>
<script src="https://hnynes.github.io/assets/js/jquery.imagesloaded.min.js"></script>
<script src="https://hnynes.github.io/assets/js/gallery.js"></script>
<script src="https://hnynes.github.io/assets/js/jquery.qrcode-0.12.0.min.js"></script>
<script src="https://hnynes.github.io/assets/js/toc.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });

  

  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>


<script src="https://hnynes.github.io/assets/js/tagcloud.js"></script>
<script>
$(document).ready(function() {
  var tags = [
    
    { "name": "java", "path": "https://hnynes.github.io/tags/#java", "length": 1 },
    
    { "name": "cplusplus", "path": "https://hnynes.github.io/tags/#cplusplus", "length": 11 },
    
    { "name": "windows", "path": "https://hnynes.github.io/tags/#windows", "length": 7 },
    
    { "name": "learn", "path": "https://hnynes.github.io/tags/#learn", "length": 8 },
    
    { "name": "mysql", "path": "https://hnynes.github.io/tags/#mysql", "length": 44 },
    
    { "name": "database", "path": "https://hnynes.github.io/tags/#database", "length": 3 },
    
    { "name": "network", "path": "https://hnynes.github.io/tags/#network", "length": 1 },
    
    { "name": "mssql", "path": "https://hnynes.github.io/tags/#mssql", "length": 50 },
    
    { "name": "项目管理", "path": "https://hnynes.github.io/tags/#项目管理", "length": 1 },
    
    { "name": "test", "path": "https://hnynes.github.io/tags/#test", "length": 1 },
    
    { "name": "python", "path": "https://hnynes.github.io/tags/#python", "length": 2 },
    
    { "name": "ruby", "path": "https://hnynes.github.io/tags/#ruby", "length": 1 },
    
    { "name": "linux", "path": "https://hnynes.github.io/tags/#linux", "length": 9 },
    
    { "name": "program", "path": "https://hnynes.github.io/tags/#program", "length": 1 },
    
    { "name": "oracle", "path": "https://hnynes.github.io/tags/#oracle", "length": 2 },
    
    { "name": "eng", "path": "https://hnynes.github.io/tags/#eng", "length": 1 },
    
    { "name": "hadoop", "path": "https://hnynes.github.io/tags/#hadoop", "length": 2 },
    
  ];
  $("#tagcloud").html(tagcloudHelper(tags));
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  $('#toc.toc-aside').toc({
    title: "文章目录",
    showEffect: "none"
  });
  $('#toc.toc-article').toc({
    title: "文章目录",
    showEffect: "show",
    showSpeed: 0
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
/*
  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      //$('.hoverqrcode').hide();
  });
  */
});
</script>




<script type="text/javascript">
var disqus_shortname = 'mars_tong';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<!--

-->




<link rel="stylesheet" href="https://hnynes.github.io/assets/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="https://hnynes.github.io/assets/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      if ($(this).hasClass('emoji')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>


<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'G-NGP86H6BVR', 'hnynes.github.io');  
ga('send', 'pageview');
</script>



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F21dd0d415985c0109a2d87d37d7bd359' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="https://hnynes.github.io/assets/img/scrollup.png"/></a>
	</div>
	<script src="https://hnynes.github.io/assets/js/totop.js"></script>


<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

